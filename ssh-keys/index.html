<!DOCTYPE html><!--[if lt IE 9]> <html lang="en-us" class="no-js lt-ie9"> <![endif]--><!--[if IE 9]> <html lang="en-us" class="no-js lt-ie10 ie9"> <![endif]--><!--[if gt IE 9]><!--><html lang="en-us" class="no-js"><!--<![endif]--><head><!-- Meta --><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="ClearType" content="true"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="apple-mobile-web-app-capable" content="yes"><!-- Title, desc --><title>SSH Keys 101 &bull; Chris Bracco</title><meta name="description" content="The first time I ever saw an SSH key was thanks to Github. Sad, I know."><!-- DNS prefetch --><link rel="dns-prefetch" href="//ajax.googleapis.com"><!-- Open Graph --><meta property="og:site_name" content="Chris Bracco"><meta property="og:title" content="SSH Keys 101 &bull; Chris Bracco"><meta property="og:type" content="article"><meta property="og:description" content="The first time I ever saw an SSH key was thanks to Github. Sad, I know."><meta property="og:url" content="https://chrisbracco.com/ssh-keys/"><meta property="article:published_time" content="2013-03-06T14:42:56+00:00"><meta property="article:author" content="https://chrisbracco.com/about/"><meta property="og:image" content="https://chrisbracco.com/assets/images/logo-58ceb15b7b.png"><!-- Twitter Cards  --><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@cbracco"><meta name="twitter:creator" content="@cbracco"><meta name="twitter:title" content="SSH Keys 101 &bull; Chris Bracco"><meta name="twitter:url" content="https://chrisbracco.com/ssh-keys/"><meta name="twitter:description" content="The first time I ever saw an SSH key was thanks to Github. Sad, I know."><meta name="twitter:image:src" content="https://chrisbracco.com/assets/images/logo-58ceb15b7b.png"><!-- Robots --><meta name="robots" content="all"><!-- Canonical --><link rel="canonical" href="https://chrisbracco.com/ssh-keys/"><!-- Favicons --><link rel="apple-touch-icon" sizes="57x57" href="/assets/favicons/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/favicons/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/favicons/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/favicons/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/favicons/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/favicons/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/favicons/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/favicons/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/assets/favicons/android-chrome-192x192.png" sizes="192x192"><link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="/assets/favicons/manifest.json"><meta name="msapplication-TileImage" content="/assets/favicons/mstile-144x144.png"><meta name="msapplication-config" content="/assets/favicons/browserconfig.xml"><meta name="apple-mobile-web-app-title" content="Chris Bracco"><meta name="application-name" content="Chris Bracco"><!-- Styles --><link rel="stylesheet" href="/assets/styles/styles-600e49731f.min.css"><!-- Scripts --><script src="/assets/scripts/head-b6983c4029.min.js"></script></head><body><div id="site" class="page layout--post padding-top-4 padding-right-4 padding-left-4 lg-padding-right-0 lg-padding-left-0" role="document"><!--[if lt IE 8]><div class="bg-color-2 color-white padding-3 margin-bottom-4 text-center">You are using an <strong>outdated</strong> browser. Please <a class="color-3" href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <a class="button button--color-black button--skiplink" href="#siteMain">Skip to Main Content</a><div id="siteHeader" class="page__header" role="banner"><div class="wrapper wrapper--lg text-center"><a id="siteLogo" class="logo" href="/" role="banner">Chris Bracco</a><h2 id="siteDescription" class="font-size-5 font-weight-400 margin-top-4">web designer, developer, etc.</h2><div id="siteNavigation" class="nav lg-position-absolute" role="navigation"><ul class="nav__list padding-left-0 lg-margin-bottom"><li class="nav__item display-inline-block"><a class="nav__link display-block text-decoration-none" href="/"><svg class="nav__link__icon icon--ground icon--size-3 margin-bottom-2"><use xlink:href="/assets/icons/sprite.svg#icon-ground"></use></svg> <span class="nav__link__text display-block font-weight-700">Blog</span></a></li><li class="nav__item display-inline-block"><a class="nav__link display-block text-decoration-none" href="/work/"><svg class="nav__link__icon icon--amplifier icon--size-3 margin-bottom-2"><use xlink:href="/assets/icons/sprite.svg#icon-amplifier"></use></svg> <span class="nav__link__text display-block font-weight-700">Work</span></a></li><li class="nav__item display-inline-block"><a class="nav__link display-block text-decoration-none" href="/info/"><svg class="nav__link__icon icon--helix icon--size-3 margin-bottom-2"><use xlink:href="/assets/icons/sprite.svg#icon-helix"></use></svg> <span class="nav__link__text display-block font-weight-700">Info</span></a></li></ul></div></div></div><div id="siteMain" class="page__main" role="main"><div class="wrapper wrapper--flush wrapper--lg"><div class="border-bottom-1px"><article class="page__content"><h1 class="lg-text-center padding-bottom-4 border-bottom-1px">SSH Keys 101</h1><div class="grid grid--gutter"><div class="grid__item width-one-whole lg-width-1/3"><div class="page__meta font-size-4 color-gray-dark margin-bottom-4">Published on March 6, 2013.</div></div><div class="grid__item width-one-whole lg-width-2/3"><div class="markdown"><p>I began by following GitHub’s <a href="https://help.github.com/articles/generating-ssh-keys">basic instructions</a> on how to generate a key pair and add it to my account, but I really didn’t have any clue what I was doing. It just worked, so I left it alone.</p><p>Since then, I’ve had to set up SSH key authentication on several local machines and remote servers, and things have become a mess. It’s time for some spring cleaning.</p><h2 id="what-is-an-ssh-key-pair">What is an SSH key pair?</h2><p>SSH keys are a means of identifying yourself to an SSH server. They are useful because they allow you access to a server, via SSH, without having to manually enter your password each time.</p><p>SSH keys always come in pairs: <strong>one private key</strong> and <strong>one public key</strong>. The private key should be safely guarded, while the public key can be shared freely on any SSH server to which you would like to connect.</p><h2 id="how-does-it-work">How does it work?</h2><p>When you use the <code class="highlighter-rouge">ssh</code> command to connect to a server that has your public SSH key on file, a few things happen behind the scenes:</p><ol><li>The SSH server uses your public SSH key to create and send your machine a “challenge”. This challenge is basically a coded message that must be met with an appropriate response or else your connection attempt will be refused.</li><li>The only thing that can decode this challenge and send the correct response is your corresponding <strong>private SSH key</strong> in the key pair. This encrypted private key usually lives in the <code class="highlighter-rouge">~/.ssh/</code> directory on your machine.</li><li>If a correct response is sent back to the SSH server, your connection will be authenticated and you will receive access.</li></ol><h2 id="managing-ssh-key-pairs">Managing SSH key pairs</h2><p>Up until now, I’ve been using keys generated on my local machines, passphrase-less keys generated on remote servers, and whatever else seemed to work. This isn’t terribly secure and it has become unmanageable — confusing, even.</p><p>I came across <a href="http://serverfault.com/questions/13354/best-system-for-managing-ssh-keys">a very helpful ServerFault thread</a> and decided that having <strong>one key pair per local machine</strong> was the best option for me.</p><p>This has several implications.</p><ol><li>You will have to delete all existing SSH stuff and start fresh. Well, maybe not, but it helped me since I’m new to this stuff.</li><li>You will have to generate one key pair on each of your workstations, and then authorize each public key on every server that you’d like to access.</li><li>You will have to set up <a href="http://www.unixwiz.net/techtips/ssh-agent-forwarding.html">SSH agent forwarding</a> so that you can use your local keys instead of leaving passphrase-less keys on every server.</li></ol><p>At the moment, I only have two machines: a 15” MacBook Pro at home, and a 27” iMac at the office. This should be a piece of cake, right?</p><p>Welp. Not really.</p><h2 id="backing-up-and-removing-all-ssh-stuff">Backing up and removing all SSH stuff</h2><p>Since my situation was such a mess, I wanted to start over with some fresh keys. You don’t necessarily have to, but it relieved some of my confusion by starting from nothing.</p><p>This was not as easy as I had hoped, but going through the motions helped me learn some new things.</p><p>So, before you go on a deleting frenzy, make sure that <code class="highlighter-rouge">PasswordAuthentication</code> is set to “Yes” on your <strong>remote server(s)</strong>, otherwise you will lock yourself out after deleting keys. And obviously, you will need to know your user passwords so you can connect to your servers the ol’ fashioned way.</p><p><code class="highlighter-rouge">PasswordAuthentication</code> is set in the <code class="highlighter-rouge">/etc/ssh/sshd_config</code> file on most of my servers. It may be the <code class="highlighter-rouge">/etc/ssh/ssh_config</code> file instead.</p><p>Shell in to each <strong>remote server</strong>, and edit this file:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh you@yourserver.com
<span class="nb">sudo </span>nano /etc/ssh/sshd_config
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PasswordAuthentication Yes
</code></pre></div></div><p>Restart SSH:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service ssh restart
</code></pre></div></div><p>Next, you will want to remove any references to your old keys from the <code class="highlighter-rouge">~/.ssh/known_hosts</code> and <code class="highlighter-rouge">~/.ssh/authorized_keys</code> files, and then remove the keys themselves. <strong>You may need to do this on your remote server(s) and your local machines.</strong></p><p>To remove the references, simply open up those files, delete the old entries, and save them.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano ~/.ssh/authorized_keys
<span class="nb">sudo </span>nano ~/.ssh/known_hosts
</code></pre></div></div><p>After deleting the references to the old keys, you will want to delete the keys themselves. If necessary, backup the old keys prior to removing them. Again, do this on your remote server(s) <em>and</em> local machines if you have keys in both places.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> ~/.ssh/id_rsa ~/.ssh/id_rsa.bak
<span class="nb">cp</span> ~/.ssh/id_rsa.pub ~/.ssh/id_rsa.pub.bak
<span class="nb">rm</span> ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
</code></pre></div></div><p>Repeat this process on all of your remote servers and local machines, so that you are back to square one. You should have to type your user password every time you try and SSH into any of your remote servers.</p><h3 id="removing-keys-from-github">Removing keys from Github</h3><p>If you are like me and have some remote servers that need to connect to Github, then you’ve probably added a few SSH keys to your account. These will also need to be deleted.</p><p>Simply login to your Github account and go to <a href="https://github.com/settings/ssh">this settings page</a> to delete them.</p><h2 id="generating-new-local-ssh-key-pairs">Generating new local SSH key pairs</h2><p>At this point I was pretty terrified with what I did, but confident I could come out the other side a victorious noob.</p><p>Creating new keys is pretty simple. You will be generating a new key on <strong>each local machine</strong> that you expect to use SSH. For me, that means creating a pair on my laptop and a pair on my work computer.</p><p>You can generate either DSA or RSA keys. I typically generate RSA keys because they have no key length limits, so you can make them larger and therefore <a href="http://www.guyrutenberg.com/2007/10/05/ssh-keygen-tutorial-generating-rsa-and-dsa-keys/">more secure</a>.</p><p>To generate a pair of public and private SSH keys, simply run this command in your terminal:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 4096 <span class="nt">-C</span> <span class="s2">"your comment"</span>
</code></pre></div></div><p>the <code class="highlighter-rouge">-t</code> flag stands for type, the <code class="highlighter-rouge">-b</code> flag stands for the key length in bits, and the <code class="highlighter-rouge">-C</code> flag stands for the comment included in the pair.</p><p>Comments in your SSH public keys can help differentiate copies of the same public key. <strong>Each copy of a public key can have its own unique comment.</strong> I like to specify the local machine in the comment (e.g. “iMac”, “MacBook”, whatever).</p><p>After running the previous <code class="highlighter-rouge">ssh-keygen</code> command, you will be prompted for the desired name and location of your private key. To accept the defaults, <strong>press return</strong> for each prompt.</p><p>Next, you will be prompted for a passphrase. Make it strong, and store it somewhere so you don’t have to remember it. I use <a href="https://agilebits.com/onepassword">1Password</a>.</p><p><strong>If you create a passphrase-less key,</strong> you will want to be aware of the risks. Without a passphrase, your private key will be stored on your machine in an unencrypted form. If some jerk gets their hands on your private key, they can assume your identity on any SSH server that is using the corresponding public key in the pair. You also must trust your root user (if it isn’t you), because they can bypass file permissions and will be able to access your private key file at any time.</p><p><strong>If you have an existing private key</strong> on your local machine that you would like to keep the same but add/change/remove the passphrase, then run the following command:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-f</span> ~/.ssh/id_rsa <span class="nt">-p</span>
</code></pre></div></div><h2 id="authorizing-public-keys-on-your-remote-servers">Authorizing public keys on your remote server(s)</h2><p>Once your new keys are generated, you will want to authorize your public keys for each server that you plan on accessing. There are several ways you can do this, but I prefer to stay in the terminal for this process, using the secure copy <code class="highlighter-rouge">scp</code> command:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp ~/.ssh/id_rsa.pub you@yourserver.com:
</code></pre></div></div><p>This command copies your public key (<code class="highlighter-rouge">id_rsa.pub</code>) to your home directory on the server. The colon <code class="highlighter-rouge">:</code> at the end of the command is important — it stands for your home directory.</p><p>Now, you will want to connect to your server via SSH, concatenate your public key to the end of the <code class="highlighter-rouge">~/.ssh/authorized_keys</code> file using the <code class="highlighter-rouge">cat</code> command, and change the permissions so that the file is only readable and writable by you:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh you@yourserver.com
<span class="nb">cat</span> ~/id_rsa.pub <span class="o">&gt;&gt;</span> ~/.ssh/authorized_keys
<span class="nb">chmod </span>700 ~/.ssh
<span class="nb">chmod </span>600 ~/.ssh/authorized_keys
</code></pre></div></div><p>After adding your public key to <code class="highlighter-rouge">~/.ssh/authorized_keys</code>, remove your key from your home directory:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> ~/id_rsa.pub
</code></pre></div></div><p><strong>Repeat this process</strong> on every remote server, for each of your public keys.</p><p>Once you are done authorizing your new keys, remember to set <code class="highlighter-rouge">PasswordAuthentication</code> back to “No” in <code class="highlighter-rouge">/etc/ssh/sshd_config</code>, and restart ssh on each remote server.</p><p>When you SSH back in, you will be prompted for your <strong>SSH passphrase</strong> (if you entered one while creating your key pair). On OSX, you can select “Remember password in my keychain” so that you don’t have to type in the passphrase every time you use <code class="highlighter-rouge">ssh</code> to access your remote server(s). Enter the password and continue, and you should be connected to your server.</p><h2 id="configuring-ssh-agent-forwarding">Configuring SSH agent forwarding</h2><p>(These forwarding instructions were mostly extracted from <a href="https://help.github.com/articles/using-ssh-agent-forwarding">this Github article</a>.)</p><p>After you authorize your new SSH key pairs, it’s time to set up agent forwarding so you can actually use the suckers.</p><p>This nifty little technique allows you to use SSH keys stored on your local machines instead of leaving passphrase-less keys sitting on your remote servers. <code class="highlighter-rouge">ssh-agent</code> runs in the background, and keeps your key stored in memory so you don’t have to enter your passphrase every time you need to use the key.</p><p>To start, you will want to create/modify the <code class="highlighter-rouge">~/.ssh/config</code> file to allow forwarding to your remote servers.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano ~/.ssh/config
</code></pre></div></div><p>Add the following, replacing <code class="highlighter-rouge">yourserver.com</code> with your remote server’s domain name or IP address:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host yourserver.com
	ForwardAgent yes
</code></pre></div></div><p>You will want to add a host entry for each remote server you would like to access. It’s more secure this way than to use a wildcard like <code class="highlighter-rouge">Host *</code>.</p><h2 id="add-your-new-local-keys-to-github">Add your new local keys to Github</h2><p>Now you will want to add your new keys in <a href="https://github.com/settings/ssh">the same spot</a> where you removed them earlier in this process. You should now be able to access Github from your remote server(s)!</p><h2 id="troubleshoot">Troubleshoot</h2><p>At this point, you may be all set up. In my case, I was still having trouble, specifically with Github. I was getting this mysterious error:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fatal: The remote end hung up unexpectedly
</code></pre></div></div><p>If you see this, you should follow the “Troubleshooting” section of <a href="https://help.github.com/articles/using-ssh-agent-forwarding">this Github article</a>.</p><p>For me, I needed to add each of my private keys to <code class="highlighter-rouge">ssh-agent</code> and everything was working again.</p><h2 id="extra-security-optional">Extra security (optional)</h2><p>These extra tweaks are to protect yourself from yourself. You will want to run these commands on your <strong>remote server(s)</strong>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>400 ~/.ssh/authorized_keys
<span class="nb">sudo </span>chattr +i ~/.ssh/authorized_keys
<span class="nb">sudo </span>chattr +i ~/.ssh
</code></pre></div></div><p>The first command makes the file read-only by you, so that it cannot be accidentally edited…by you. The second command prevents you, the user, from simply changing the permissions back. The third command prevents you from accidentally renaming the <code class="highlighter-rouge">~/.ssh/</code> folder.</p><p>This of course assumes that you will not need to change the file. If you end up having to change something in the future, then you will have to reverse this process in order to edit the file again.</p><h2 id="conclusion">Conclusion</h2><p>The learning curve for this was much higher than I had expected, but I’m glad I muscled through it. I am still very new to all of this, so if there is something I am doing wrong or could be doing better please feel free to flame me in the comments.</p></div><div class="page__comments border-top-1px padding-top-4 padding-bottom-4"><h1>Leave a Comment</h1><div id="disqus_thread"></div><script>var disqus_config = function () {
        this.page.url = 'https://chrisbracco.com/ssh-keys/';
        // this.page.identifier = PAGE_IDENTIFIER;
    };

    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//cbracco.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div></article></div></div></div><div id="siteFooter" class="page__footer" role="contentinfo"><div class="wrapper wrapper--flush wrapper--lg padding-top-4 padding-bottom-4"><p class="font-size-4 margin-bottom-0"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" title="The content on this website is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License, unless otherwise noted.">CC BY-SA 4.0</a> &middot; 2012-2019 &middot; <a href="https://chrisbracco.com/feed.xml" title="Subscribe to the RSS Feed">RSS Feed</a></p></div></div></div><!-- Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-12953082-11', 'auto');
  ga('require', 'displayfeatures');
  ga('set', 'anonymizeIp', true);

  
  ga('send', 'pageview');</script><!-- Scripts --><script src="/assets/scripts/scripts-8fe1d2f111.min.js"></script></body></html>