<!DOCTYPE html><!--[if lt IE 9]> <html lang="en-us" class="no-js lt-ie9"> <![endif]--><!--[if IE 9]> <html lang="en-us" class="no-js lt-ie10 ie9"> <![endif]--><!--[if gt IE 9]><!--><html lang="en-us" class="no-js"><!--<![endif]--><head><!-- Meta --><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="ClearType" content="true"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="apple-mobile-web-app-capable" content="yes"><!-- Title, desc --><title>How to Configure a Linode VPS Server to Run Ubuntu 12.04 LTS with a LEMP Stack &bull; Chris Bracco</title><meta name="description" content="While configuring my VPS server from scratch, I kept detailed notes that I could reference later on if I ever ran into issues or had to start over. This article is a “how-to” writeup of those notes."><!-- DNS prefetch --><link rel="dns-prefetch" href="//ajax.googleapis.com"><!-- Open Graph --><meta property="og:site_name" content="Chris Bracco"><meta property="og:title" content="How to Configure a Linode VPS Server to Run Ubuntu 12.04 LTS with a LEMP Stack &bull; Chris Bracco"><meta property="og:type" content="article"><meta property="og:description" content="While configuring my VPS server from scratch, I kept detailed notes that I could reference later on if I ever ran into issues or had to start over. This article is a “how-to” writeup of those notes."><meta property="og:url" content="https://chrisbracco.com/vps/"><meta property="article:published_time" content="2013-02-21T13:07:58-05:00"><meta property="article:author" content="https://chrisbracco.com/about/"><meta property="og:image" content="https://chrisbracco.com/assets/images/logo-58ceb15b7b.png"><!-- Twitter Cards  --><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@cbracco"><meta name="twitter:creator" content="@cbracco"><meta name="twitter:title" content="How to Configure a Linode VPS Server to Run Ubuntu 12.04 LTS with a LEMP Stack &bull; Chris Bracco"><meta name="twitter:url" content="https://chrisbracco.com/vps/"><meta name="twitter:description" content="While configuring my VPS server from scratch, I kept detailed notes that I could reference later on if I ever ran into issues or had to start over. This article is a “how-to” writeup of those notes."><meta name="twitter:image:src" content="https://chrisbracco.com/assets/images/logo-58ceb15b7b.png"><!-- Robots --><meta name="robots" content="all"><!-- Canonical --><link rel="canonical" href="https://chrisbracco.com/vps/"><!-- Favicons --><link rel="apple-touch-icon" sizes="57x57" href="/assets/favicons/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/favicons/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/favicons/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/favicons/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/favicons/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/favicons/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/favicons/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/favicons/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/assets/favicons/android-chrome-192x192.png" sizes="192x192"><link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="/assets/favicons/manifest.json"><meta name="msapplication-TileImage" content="/assets/favicons/mstile-144x144.png"><meta name="msapplication-config" content="/assets/favicons/browserconfig.xml"><meta name="apple-mobile-web-app-title" content="Chris Bracco"><meta name="application-name" content="Chris Bracco"><!-- Styles --><link rel="stylesheet" href="/assets/styles/styles-600e49731f.min.css"><!-- Scripts --><script src="/assets/scripts/head-b6983c4029.min.js"></script></head><body><div id="site" class="page layout--post padding-top-4 padding-right-4 padding-left-4 lg-padding-right-0 lg-padding-left-0" role="document"><!--[if lt IE 8]><div class="bg-color-2 color-white padding-3 margin-bottom-4 text-center">You are using an <strong>outdated</strong> browser. Please <a class="color-3" href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <a class="button button--color-black button--skiplink" href="#siteMain">Skip to Main Content</a><div id="siteHeader" class="page__header" role="banner"><div class="wrapper wrapper--lg text-center"><a id="siteLogo" class="logo" href="/" role="banner">Chris Bracco</a><h2 id="siteDescription" class="font-size-5 font-weight-400 margin-top-4">web designer, developer, etc.</h2><div id="siteNavigation" class="nav lg-position-absolute" role="navigation"><ul class="nav__list padding-left-0 lg-margin-bottom"><li class="nav__item display-inline-block"><a class="nav__link display-block text-decoration-none" href="/"><svg class="nav__link__icon icon--ground icon--size-3 margin-bottom-2"><use xlink:href="/assets/icons/sprite.svg#icon-ground"></use></svg> <span class="nav__link__text display-block font-weight-700">Blog</span></a></li><li class="nav__item display-inline-block"><a class="nav__link display-block text-decoration-none" href="/work/"><svg class="nav__link__icon icon--amplifier icon--size-3 margin-bottom-2"><use xlink:href="/assets/icons/sprite.svg#icon-amplifier"></use></svg> <span class="nav__link__text display-block font-weight-700">Work</span></a></li><li class="nav__item display-inline-block"><a class="nav__link display-block text-decoration-none" href="/info/"><svg class="nav__link__icon icon--helix icon--size-3 margin-bottom-2"><use xlink:href="/assets/icons/sprite.svg#icon-helix"></use></svg> <span class="nav__link__text display-block font-weight-700">Info</span></a></li></ul></div></div></div><div id="siteMain" class="page__main" role="main"><div class="wrapper wrapper--flush wrapper--lg"><div class="border-bottom-1px"><article class="page__content"><h1 class="lg-text-center padding-bottom-4 border-bottom-1px">How to Configure a Linode VPS Server to Run Ubuntu 12.04 LTS with a LEMP Stack</h1><div class="grid grid--gutter"><div class="grid__item width-one-whole lg-width-1/3"><div class="page__meta font-size-4 color-gray-dark margin-bottom-4">Published on February 21, 2013.</div></div><div class="grid__item width-one-whole lg-width-2/3"><div class="markdown"><p>My command line usage skyrocketed in 2012. Being a slave to shared hosting is not fun, and I finally built the confidence (and cash flow) necessary to upgrade to a <abbr title="Virtual Private Server">VPS</abbr>. The problem was that I had no idea what to do after purchasing the VPS, let alone which company to go with.</p><p>After much deliberation, I settled on <a href="http://cbrac.co/linode_ref">Linode</a>. The plans are affordable and they receive rave reviews from developers who are way smarter than me. Also, they have <a href="http://library.linode.com/">an incredible knowledgebase</a> to help us sysadmin noobs get started.</p><ol><li><a href="#start">Getting started</a></li><li><a href="#dns">Adding DNS Records</a></li><li><a href="#connect">Connect to your VPS</a></li><li><a href="#stability">Basic server stability</a></li><li><a href="#security">Basic server security</a></li><li><a href="#relay">Postfix + Gmail SMTP server relay</a></li><li><a href="#more-security">More security</a></li><li><a href="#lemp">Install a barebones LEMP stack</a></li><li><a href="#nginx">Configure Nginx</a></li><li><a href="#php5-fpm">Configure php5-fpm</a></li><li><a href="#vhosts">Configure Nginx server blocks (virtual hosts)</a></li><li><a href="#git">Installing Git and using GitHub</a></li><li><a href="#conclusion">Conclusion</a></li></ol><p><a name="start"></a></p><h2 id="getting-started">Getting started</h2><ol><li>March on over to <a href="http://cbrac.co/linode_ref">Linode</a> and pick a plan. I signed up for their entry-level “Linode 512” plan. You can always upgrade later.</li><li>Log in to <a href="https://manager.linode.com/">Linode Manager</a> and select a data center. I chose Newark, NJ.</li><li>Deploy an Ubuntu 12.04 LTS linux distribution, leaving default values for “Disk Size” and “Swap Disk”.</li><li>Boot up the VPS for the first time by selecting it in the <a href="https://manager.linode.com/">Linode Manager</a> and clicking “Boot”.</li></ol><h4 id="useful-links">Useful links</h4><ul><li><a href="http://library.linode.com/getting-started">Getting Started - Linode Library</a></li></ul><p><a name="dns"></a></p><h2 id="adding-dns-records">Adding DNS records</h2><p>Now is a good time to map your domain name to the VPS. Be aware that this process can take a while sometimes, so allow up to 24 hours for DNS changes to be reflected across the web.</p><ol><li>Add a master DNS zone for [yourdomain.com] in the <a href="https://manager.linode.com/">Linode Manager</a>.</li><li><p>Navigate to your domain’s registrar (I use <a href="http://cbrac.co/namecheap_ref">Namecheap</a>) and set the following name servers:</p><p>ns1.linode.com ns2.linode.com ns3.linode.com ns4.linode.com ns5.linode.com</p></li></ol><h3 id="set-up-reverse-dns">Set up reverse DNS</h3><p>Though not typically required, reverse DNS is helpful if you ever have to do any network troubleshooting (such as traceroute, ping, etc) or are concerned with spam emails. It only takes a moment to set up, so why not?</p><ol><li>From the <a href="https://manager.linode.com/">Linode Manager</a>, click the “Remote Access” tab</li><li>Click “Reverse DNS”</li><li>Enter [yourdomain.com] as the domain</li><li>Click “Lookup”</li><li>After your domain is found, confirm by clicking “Yes”</li></ol><h4 id="useful-links-1">Useful links</h4><ul><li><a href="http://library.linode.com/hosting-website">Hosting a Website - Linode Library</a></li></ul><p><a name="connect"></a></p><h2 id="connect-to-your-vps">Connect to your VPS</h2><p>After you’ve got the VPS booted and running, it’s time for the fun to begin. Right off the bat you should “shell in” to the VPS using the <code class="highlighter-rouge">ssh</code> command from your terminal, set the hostname, edit your hosts file, and set the default language.</p><p><strong>Since I am a Mac OSX user, all command line instructions are written as such. This can all be done from any operating system — simply use the equivalent syntax for your operating system’s command prompt.</strong></p><p>Open Terminal on your Mac, or if you are on Windows download and open <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">putty</a>, since Windows doesn’t ship with a very good command prompt.</p><p>Connect to the VPS:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh root@&lt;your IP address&gt;
</code></pre></div></div><p>Set your hostname, verify it, and reconnect to the VPS:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"your hostname"</span> <span class="o">&gt;</span> /etc/hostname
<span class="nb">hostname</span> <span class="nt">-F</span> /etc/hostname
<span class="nb">hostname</span>
</code></pre></div></div><p>Set the fully qualified domain name (FQDN):</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano /etc/hosts
</code></pre></div></div><p>Add the following line and save the file <strong>(Ctrl + X saves the file in nano)</strong>:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 &lt;your hostname&gt;.&lt;yourdomain.com&gt; &lt;yourhostname&gt;
</code></pre></div></div><p>Set the language and time zone:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>locale-gen en_US.UTF-8
update-locale <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
dpkg-reconfigure tzdata
<span class="nb">date</span>
</code></pre></div></div><h4 id="useful-links-2">Useful links</h4><ul><li><a href="http://library.linode.com/getting-started">Getting Started - Linode Library</a></li><li><a href="http://en.wikipedia.org/wiki/Hosts_(file)">Hosts (file)</a></li><li><a href="http://en.wikipedia.org/wiki/Fully_qualified_domain_name">Fully qualified domain name</a></li></ul><h2 id="google-apps">Google Apps</h2><p>There are several different ways you can set up an email server on a VPS. Since I already use <a href="http://google.com/a">Google Apps</a> with this domain, it made sense for me to link it up to my VPS as well. This setup is probably not optimal for everyone, but it works for me.</p><p><strong>These directions assume that you’ve already signed up and configured a Google Apps account for your domain.</strong></p><p>Create a new API key by clicking on “my profile” in the <a href="https://manager.linode.com/">Linode Manager</a>, confirming your password, and clicking the “Generate a new API key” button.</p><p>Download the <a href="https://github.com/theckman/gapps-linode-dns">gapps-linode-dns</a> script onto the VPS:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>wget <span class="s2">"https://raw.github.com/theckman/gapps-linode-dns/master/gapps-linode-dns.sh"</span>
</code></pre></div></div><ol><li>Make the script executable and run it:</li></ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x gapps-linode-dns.sh
./gapps-linode-dns.sh
</code></pre></div></div><p>Paste in your API key, domain name, and answer “y” to the rest of the configuration questions. Wait a few minutes, and ask a friend to send some test emails to ensure it’s working properly.</p><h4 id="useful-links-3">Useful links</h4><ul><li><a href="http://library.linode.com/email/google-mail">Using Google Apps for Email</a></li><li><a href="https://github.com/theckman/gapps-linode-dns">gapps-linode-dns script</a></li></ul><p><a name="stability"></a></p><h2 id="basic-server-stability">Basic server stability</h2><p>In the event of a traffic spike, the VPS may run out of memory and your site could be down for hours, well after the spike has ended. To avoid the extended downtime, you’ll want the VPS to automatically reboot instead. It’s one less thing for you to worry about and provides a bit more stability (a few minutes of downtime as opposed to hours).</p><p>Set the server to automatically reboot when it runs out of memory:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/sysctl.conf
</code></pre></div></div><p>Add the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vm.panic_on_oom=1
kernel.panic=10
</code></pre></div></div><h4 id="useful-links-4">Useful links</h4><ul><li><a href="http://feross.org/how-to-setup-your-linode/">How To Set Up Your Linode For Maximum Awesomeness</a></li></ul><p><a name="security"></a></p><h2 id="basic-server-security">Basic server security</h2><p>This part is extensive, and for good reason. Security is the most important part of configuring a web server. Below are several measures to make sure you’ve got a good foundation in place to safeguard your server.</p><p>Create a new user:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adduser &lt;your username&gt;
visudo
</code></pre></div></div><p>Add the following line and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;your username&gt; ALL=(ALL:ALL) ALL
</code></pre></div></div><p>Configure SSH:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano /etc/ssh/sshd_config
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Port &lt;your port number&gt;
Protocol 2
PermitRootLogin no
PermitEmptyPasswords no
UseDNS no
AllowUsers yourusername
</code></pre></div></div><p><small><em>You should choose a port number that is less than 1024, and not 22. <a href="http://unix.stackexchange.com/questions/16564/why-are-the-first-1024-ports-restricted-to-the-root-user-only">Here’s why</a>.</em></small></p><p>Restart SSH:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service ssh restart
</code></pre></div></div><p>Login as new user:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exit
</span>ssh <span class="nt">-p</span> &lt;your port number&gt; &lt;your username&gt;@&lt;yourdomain.com&gt;
</code></pre></div></div><p>Update Ubuntu:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get upgrade <span class="nt">--show-upgraded</span>
</code></pre></div></div><p><small>If you get the error <strong>“resolvconf: Error: /etc/resolv.conf isn’t a symlink, not doing anything”</strong> while updating, run the command below, answering “yes” to all the prompts, and reboot the VPS from the <a href="https://manager.linode.com/">Linode Manager</a> dashboard:</small></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>dpkg-reconfigure resolvconf
</code></pre></div></div><p>Enable automatic security updates:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>unattended-upgrades
<span class="nb">sudo </span>nano /etc/apt/apt.conf.d/10periodic
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
</code></pre></div></div><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/apt/apt.conf.d/50unattended-upgrades
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unattended-Upgrade::Allowed-Origins {
	"Ubuntu lucid-security";
	//"Ubuntu lucid-updates";
};
</code></pre></div></div><p>Generate SSH keys on your local machine for passwordless login:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-C</span> <span class="s2">"Your comment"</span>
</code></pre></div></div><p>Secure copy the public key from your local machine to the VPS:</p><p><small>On the VPS, run:</small></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> <span class="nt">-p</span> ~/.ssh/authorized_keys
<span class="nb">sudo chown</span> <span class="nt">-R</span> &lt;your username&gt;:&lt;your username&gt; .ssh
</code></pre></div></div><p><small>On your local machine, run:</small></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp <span class="nt">-P</span> &lt;your port number&gt; ~/.ssh/id_rsa.pub &lt;your username&gt;@&lt;yourdomain.com&gt;:
</code></pre></div></div><p><small>On the VPS, run:</small></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> ~/id_rsa.pub <span class="o">&gt;&gt;</span> ~/.ssh/authorized_keys
<span class="nb">sudo chmod </span>700 .ssh
<span class="nb">sudo chmod </span>600 .ssh/authorized_keys
<span class="nb">sudo rm</span> ~/id_rsa.pub
<span class="nb">exit
</span>ssh <span class="nt">-p</span> &lt;your port number&gt; &lt;your username&gt;@&lt;yourdomain.com&gt;
</code></pre></div></div><p>Configure firewall with ufw:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>nmap
nmap <span class="nt">-v</span> <span class="nt">-sT</span> localhost
<span class="nb">sudo </span>ufw default deny incoming
<span class="nb">sudo </span>ufw default allow outgoing
<span class="nb">sudo </span>ufw logging on
<span class="nb">sudo </span>ufw allow ssh/tcp
<span class="nb">sudo </span>ufw allow http/tcp
<span class="nb">sudo </span>ufw allow 443
<span class="nb">sudo </span>ufw allow &lt;your port number&gt;
<span class="nb">sudo </span>ufw <span class="nb">enable
sudo </span>ufw status
</code></pre></div></div><p>Secure shared memory:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/fstab
</code></pre></div></div><p>Add the following line and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tmpfs /dev/shm tmpfs defaults,noexec,nosuid 0 0
</code></pre></div></div><p>Mount that shit:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mount <span class="nt">-a</span>
</code></pre></div></div><p>Install Fail2Ban to prevent repeated login attempts:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>fail2ban
<span class="nb">sudo cp</span> /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
<span class="nb">sudo </span>nano /etc/fail2ban/jail.local
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>destemail = &lt;you@youremail.com&gt;
action = %(action_mwl)s

[ssh]

enabled  = true
port     = &lt;your port number&gt;
filter   = sshd
logpath  = /var/log/auth.log
maxretry = 6

[ssh-ddos]

enabled  = true
port     = &lt;your port number&gt;
filter   = sshd-ddos
logpath  = /var/log/auth.log
maxretry = 6
</code></pre></div></div><p>Restart Fail2Ban:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service fail2ban restart
</code></pre></div></div><p>Harden network with sysctl settings:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/sysctl.conf
</code></pre></div></div><p>Edit the file and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># IP Spoofing protection
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Ignore ICMP broadcast requests
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Disable source packet routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Ignore send redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Block SYN attacks
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5

# Log Martians
net.ipv4.conf.all.log_martians = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Ignore ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Ignore Directed pings
net.ipv4.icmp_echo_ignore_all = 1
</code></pre></div></div><p>Apply new settings:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>sysctl <span class="nt">-p</span>
</code></pre></div></div><p>Prevent IP Spoofing:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/host.conf
</code></pre></div></div><p>Add the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>order bind,hosts
nospoof on
</code></pre></div></div><p><a name="relay"></a></p><h2 id="postfix--gmail-smtp-server-relay">Postfix + Gmail SMTP server relay</h2><p>If you ever need to set up cron jobs, or would like error and log reports emailed to you, then pay attention to this section. The below instructions will show you how to configure Postfix to send important server emails to your Google Apps email account.</p><p>Install Postfix and its dependencies:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>postfix libsasl2-2 ca-certificates libsasl2-modules
</code></pre></div></div><p>Edit main.cf:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/postfix/main.cf
</code></pre></div></div><p>Add the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sets gmail as relay
relayhost = [smtp.gmail.com]:587

# use tls
smtp_use_tls=yes

# use sasl when authenticating to foreign SMTP servers
smtp_sasl_auth_enable = yes

# path to password map file
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd

# list of CAs to trust when verifying server certificate
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt

# eliminates default security options which are imcompatible with gmail
smtp_sasl_security_options =
</code></pre></div></div><p>Edit sasl_passwd:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/postfix/sasl_passwd
</code></pre></div></div><p>Add the following line and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[smtp.gmail.com]:587  &lt;your gmail username&gt;:&lt;your gmail password&gt;
</code></pre></div></div><p>Chown sasl_passwd:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>postmap /etc/postfix/sasl_passwd
<span class="nb">sudo chown </span>postfix /etc/postfix/sasl_passwd<span class="k">*</span>
</code></pre></div></div><p>Reload Postfix and send a test email:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service postfix reload
sendmail &lt;<span class="nb">test </span>email address&gt; This email worked! <span class="nb">.</span>
</code></pre></div></div><h4 id="useful-links-5">Useful links</h4><ul><li><a href="http://mhawthorne.net/posts/postfix-configuring-gmail-as-relay.html">Postfix: Configuring Gmail as Relay</a></li></ul><p><a name="more-security"></a></p><h2 id="more-server-security">More server security</h2><p>There is no such thing as “enough” security. You can always do more to make sure your web server is safe and secure, so that’s what you’ll do next.</p><p>Check for rootkits with RKHunter and CHKRootKit:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>rkhunter chkrootkit
<span class="nb">sudo </span>chkrootkit
<span class="nb">sudo </span>rkhunter <span class="nt">--update</span>
<span class="nb">sudo </span>rkhunter <span class="nt">--propupd</span>
<span class="nb">sudo </span>rkhunter <span class="nt">--check</span>
</code></pre></div></div><p>Analyze system log files with LogWatch:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>logwatch libdate-manip-perl
<span class="nb">sudo </span>logwatch | less
<span class="nb">sudo </span>logwatch <span class="nt">--mailto</span> &lt;your email address&gt; <span class="nt">--output</span> mail <span class="nt">--format</span> html <span class="nt">--range</span> <span class="s1">'between -7 days and today'</span>
</code></pre></div></div><p>Audit system security with Tiger:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>tiger
<span class="nb">sudo </span>tiger
<span class="nb">sudo </span>less /var/log/tiger/security.report.<span class="k">*</span>
</code></pre></div></div><h4 id="useful-links-6">Useful links</h4><ul><li><a href="http://www.thefanclub.co.za/how-to/how-secure-ubuntu-1204-lts-server-part-1-basics">How to secure an Ubuntu 12.04 LTS server</a></li></ul><p><a name="lemp"></a></p><h2 id="install-a-barebones-lemp-stack">Install a barebones LEMP stack</h2><p>Instead of a traditional <abbr title="Linux, Apache, MySQL, PHP">LAMP</abbr> stack, I decided to give <a href="http://wiki.nginx.org/Main">nginx</a> a whirl instead of <a href="http://www.apache.org/">Apache</a>. Nginx excels at serving small static sites, which is what I have here. If you’d like to use a similar stack on your server, then follow the guidelines below.</p><p>Add PPAs for Nginx and PHP, as Ubuntu’s defaults are quite outdated:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>python-software-properties
<span class="nb">sudo </span>add-apt-repository ppa:nginx/stable
<span class="nb">sudo </span>add-apt-repository ppa:ondrej/php5
<span class="nb">sudo </span>apt-get update
</code></pre></div></div><p>Install Nginx, MySQL, PHP, and all dependencies:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>mysql-server nginx php5 php5-fpm php5-cli php5-mysql php5-curl php5-gd php5-intl php-pear php5-imagick php5-imap php5-mcrypt php5-memcache php5-ming php5-ps php5-pspell php5-recode php5-snmp php5-sqlite php5-tidy php5-xmlrpc php5-xsl php5-xcache
</code></pre></div></div><ol><li>Start Nginx, php5-fpm, and MySQL:</li></ol><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-cache search php5 | <span class="nb">grep </span>php5
<span class="nb">sudo </span>service nginx start
<span class="nb">sudo </span>service php5-fpm start
<span class="nb">sudo </span>start mysql
ifconfig eth0 | <span class="nb">grep </span>inet | <span class="nb">awk</span> <span class="s1">'{ print $2 }'</span>
</code></pre></div></div><p><a name="nginx"></a></p><h2 id="configure-nginx">Configure Nginx</h2><p>Below is a set of useful defaults for a typical Nginx setup. I find this is a good starting point, but don’t be afraid to do your own tests, tweaks, and refinements.</p><p>Modify the nginx.conf file:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/nginx/nginx.conf
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>worker_processes 4;
keepalive_timeout 2;
</code></pre></div></div><p>Make a backup copy of Nginx’s “default” file and modify the original:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp</span> /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak
<span class="nb">sudo </span>nano /etc/nginx/sites-available/default
</code></pre></div></div><p>Edit the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
	listen   80; ## listen for ipv4; this line is default and implied
	listen   [::]:80 default ipv6only=on; ## listen for ipv6

	root /usr/share/nginx/html;
	index index.html index.htm index.php;

	# Make site accessible from http://localhost/
	server_name _;
	location / {
		try_files $uri $uri/ /index.html;
	}

	location /doc/ {
		alias /usr/share/doc/;
		autoindex on;
		allow 127.0.0.1;
		deny all;
	}

	# Redirect server error pages to the static page /50x.html
	error_page 500 502 503 504 /50x.html;
	location = /50x.html {
		root /usr/share/nginx/html;
	}

	# Pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
	location ~ \.php$ {
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass unix:/tmp/php5-fpm.sock;
		fastcgi_index index.php;
		include fastcgi_params;
	}

	# Deny access to .htaccess files, if Apache's document root concurs
	# with Nginx’s one
	location ~ /\.ht {
		deny all;
	}
}
</code></pre></div></div><p><a name="php5-fpm"></a></p><h2 id="configure-php5-fpm">Configure php5-fpm</h2><p>Once Nginx is configured, we have to make it place nice with PHP. That’s where php5-fpm comes in.</p><p>Modify the php.ini file:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/php5/fpm/php.ini
</code></pre></div></div><p>Edit the following line and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cgi.fix_pathinfo = 0
</code></pre></div></div><p>Modify the www.conf file:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/php5/fpm/pool.d/www.conf
</code></pre></div></div><p>Edit the following line and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listen = /tmp/php5-fpm.sock
</code></pre></div></div><p>Reload php5-fpm and nginx:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service php5-fpm reload
<span class="nb">sudo </span>service nginx reload
</code></pre></div></div><p>Create info.php:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /usr/share/nginx/html/info.php
</code></pre></div></div><p>Add the following line and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">phpinfo</span><span class="p">();</span> <span class="cp">?&gt;</span>
</code></pre></div></div><p>Visit http://youripaddress/info.php in a web browser. You should see a bunch of PHP information on this page.</p><p><a name="vhosts"></a></p><h2 id="configure-nginx-server-blocks-aka-virtual-hosts">Configure Nginx server blocks (aka virtual hosts)</h2><p>In Nginx, virtual hosts are called “server blocks”. Below you will set up a virtual host for your domain so that it can be viewed at http://yourdomain.com.</p><p>Create a directory for your domain:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/www/[yourdomain.com]/<span class="o">{</span>public_html,logs<span class="o">}</span>
<span class="nb">sudo chown</span> <span class="nt">-R</span> <span class="o">[</span>your username]:www-data /var/www/[yourdomain.com]/public_html
<span class="nb">sudo chmod</span> <span class="nt">-R</span> 755 /var/www
</code></pre></div></div><p>Create a “Hello world” index page:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /var/www/&lt;yourdomain.com&gt;/public_html/index.php
</code></pre></div></div><p>Add the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
	<span class="nt">&lt;head&gt;</span>
		<span class="nt">&lt;title&gt;</span>Hello world<span class="nt">&lt;/title&gt;</span>
	<span class="nt">&lt;/head&gt;</span>
	<span class="nt">&lt;body&gt;</span>
		<span class="nt">&lt;h1&gt;</span>Hello world!<span class="nt">&lt;/h1&gt;</span>
	<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>Create an Nginx config file for your domain:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/nginx/sites-available/&lt;yourdomain.com&gt;
</code></pre></div></div><p>Add the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
	server_name &lt;www.yourdomain.com&gt;;

	# Rewrite www to non-www
	rewrite ^(.*) http://&lt;yourdomain.com&gt;$1 permanent;
}

server {
	# Listening ports
	listen 80;      ## listen for ipv4; this line is default and implied
	listen [::]:80; ## listen for ipv6

	# Make site accessible from domain
	server_name &lt;yourdomain.com&gt;;

	# Root directory
	root /var/www/&lt;yourdomain.com&gt;/public_html;
	index index.html index.htm index.php;

	# Logs
	access_log /var/www/&lt;yourdomain.com&gt;/logs/access.log;
	error_log /var/www/&lt;yourdomain.com&gt;/logs/error.log;

	# Includes
	include global/restrictions.conf;
}
</code></pre></div></div><p>Create global/restrictions.conf:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /etc/nginx/global
<span class="nb">sudo </span>nano /etc/nginx/global/restrictions.conf
</code></pre></div></div><p>Add the following lines and save:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Global restrictions configuration file.
# Designed to be included in any server {} block.&amp;lt;/p&amp;gt;
location = /favicon.ico {
	log_not_found off;
	access_log off;
}

location = /robots.txt {
	allow all;
	log_not_found off;
	access_log off;
}

# Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).
# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
location ~ /\. {
	deny all;
}

# Deny access to any files with a .php extension in the uploads directory
# Works in sub-directory installs and also in multisite network
# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
location ~* /(?:uploads|files)/.*\.php$ {
	deny all;
}
</code></pre></div></div><p>Create a symbolic link for your domain’s config file from “/sites-available” to “/sites-enabled”:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ln</span> <span class="nt">-s</span> /etc/nginx/sites-available/&lt;yourdomain.com&gt; /etc/nginx/sites-enabled/&lt;yourdomain.com&gt;
</code></pre></div></div><p>Reload php5-fpm and nginx:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service php5-fpm reload
<span class="nb">sudo </span>service nginx reload
</code></pre></div></div><p><a name="git"></a></p><h2 id="installing-git-and-using-github">Installing Git and using GitHub</h2><p>I had a hard time wrapping my head around <a href="http://git-scm.com/">Git</a> for quite a while, but it eventually just “clicked” for me and now I am addicted. If you want to use Git on your server and host your domain’s code on GitHub, then follow these steps. This is a very basic workflow, but it satisfies my needs for the moment.</p><h3 id="on-your-local-machines">On your local machine(s)</h3><p>First, <a href="http://git-scm.com/downloads">download &amp; install Git</a> on your local machine(s). Then, <a href="http://github.com">sign up for GitHub</a>, and create a new repository called “yourdomain.com” with a default README.md file included.</p><p>Set your default name and email:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git config <span class="nt">--global</span> user.name <span class="s2">"your github username"</span>
git config <span class="nt">--global</span> user.email <span class="s2">"you@youremail.com"</span>
</code></pre></div></div><p>If you’re on OSX, cache your password so you don’t have to type it each time:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git config <span class="nt">--global</span> credential.helper osxkeychain
</code></pre></div></div><p>Create a folder on your local machine called<yourdomain.com>, and clone your new GitHub repository into the empty folder you just created:</yourdomain.com></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /path/to/yourdomain.com
git clone https://github.com/&lt;your github username&gt;/&lt;yourdomain.com&gt;.git <span class="nb">.</span>
</code></pre></div></div><p>Make some changes to the README.md file, commit, and push README.md to your GitHub repository to ensure everything is working properly:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git commit <span class="nt">-am</span> <span class="s2">"My first commit!"</span>
git remote add origin https://github.com/&lt;your_username&gt;/&lt;yourdomain.com&gt;.git
git push origin master
</code></pre></div></div><p>View your repository on GitHub to make sure the changes were successfully committed and pushed from your local machine.</p><h3 id="on-the-vps">On the VPS</h3><p>Download &amp; install Git on your server:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>git-core
</code></pre></div></div><p>Clone your repository from GitHub into your domain’s “public_html” directory <strong>(make sure this directory is empty beforehand — you may need to delete the <code class="highlighter-rouge">index.php</code> file from earlier if you created one)</strong>, and pull in the most recent changes:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /var/www/&lt;yourdomain.com&gt;/public_html/
git clone https://github.com/&lt;your_username&gt;/&lt;yourdomain.com&gt;.git <span class="nb">.</span>
git pull
</code></pre></div></div><p>Your domain’s “public_html” directory on the VPS should now contain all the files from your GitHub repository. Whenever you want to update your live site with whatever changes you’ve pushed to your GitHub repository from your local machine, just do a <code class="highlighter-rouge">git pull</code> from the “public_html” directory for your domain on the VPS.</p><h4 id="helpful-links">Helpful links</h4><ul><li><a href="https://help.github.com/articles/set-up-git">Set up Git</a></li><li><a href="https://help.github.com/articles/create-a-repo">Create a Repo</a></li></ul><p><a name="conclusion"></a></p><h2 id="conclusion">Conclusion</h2><p>Phew. Exhausted yet? If you followed along, you should have a basic server ready to host your websites. Documenting this whole process helped me learn a alot about basic server configuration. Please post any questions and comments below.</p></div><div class="page__comments border-top-1px padding-top-4 padding-bottom-4"><h1>Leave a Comment</h1><div id="disqus_thread"></div><script>var disqus_config = function () {
        this.page.url = 'https://chrisbracco.com/vps/';
        // this.page.identifier = PAGE_IDENTIFIER;
    };

    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//cbracco.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div></article></div></div></div><div id="siteFooter" class="page__footer" role="contentinfo"><div class="wrapper wrapper--flush wrapper--lg padding-top-4 padding-bottom-4"><p class="font-size-4 margin-bottom-0"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" title="The content on this website is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License, unless otherwise noted.">CC BY-SA 4.0</a> &middot; 2012-2020 &middot; <a href="https://chrisbracco.com/feed.xml" title="Subscribe to the RSS Feed">RSS Feed</a></p></div></div></div><!-- Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-12953082-11', 'auto');
  ga('require', 'displayfeatures');
  ga('set', 'anonymizeIp', true);

  
  ga('send', 'pageview');</script><!-- Scripts --><script src="/assets/scripts/scripts-8fe1d2f111.min.js"></script></body></html>